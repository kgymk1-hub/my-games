<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>10ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;

      /* â˜…ä¿®æ­£: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒå¢—ãˆã¦ã‚‚ä¸ŠãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«ã€ä¸­å¤®å›ºå®šã‚’ã‚„ã‚ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
      min-height: 100vh;
      height: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px 12px;
      box-sizing: border-box;
      overflow-y: auto;

      background: #e9eef8;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      /* è¿½åŠ : é€£æ‰“æ™‚ãªã©ã®ãƒ†ã‚­ã‚¹ãƒˆç¯„å›²é¸æŠã‚’é˜²ã„ã§æ²¡å…¥æ„ŸUP */
      user-select: none;
      -webkit-user-select: none;
    }

    .container {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      text-align: center;

      /* â˜…ä¿®æ­£: ç«¯æœ«å¹…ã«åˆã‚ã›ã¦ç¸®ã‚€ */
      width: min(360px, 100%);
      box-sizing: border-box;
    }

    h1 {
      margin: 0 0 16px;
      font-size: 1.2rem;
    }

    .time {
      font-size: 2rem;
      margin: 16px 0;
      min-height: 2.2rem;
      color: #333;
    }

    button {
      width: 100%;
      padding: 12px 0;
      font-size: 1rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 8px;
      transition: 0.1s;
      color: white;
      background: #4b6fff;
      touch-action: manipulation; /* ã‚¿ãƒƒãƒ—æ™‚ã®ä½™è¨ˆãªé…å»¶ã‚’æ¸›ã‚‰ã™ */
    }

    button:active { transform: translateY(1px); }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .result {
      margin-top: 12px;
      font-size: 1rem;
      min-height: 1.2rem;
    }

    .hiscore {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #444;
      background: #f4f7ff;
      border-radius: 10px;
      padding: 12px 12px;
      text-align: left;
      line-height: 1.35;

      /* è¿½åŠ : ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã‚³ãƒ”ãƒ¼ã§ãã‚‹æ–¹ãŒè¦ªåˆ‡ */
      user-select: text;
      -webkit-user-select: text;
    }

    .hiscore b { color: #2a46c6; }

    .rankhead {
      margin-top: 0;
      font-weight: 700;
      font-size: 0.95rem;
      color: #2a46c6;
    }

    .ranklist {
      margin: 6px 0 0;
      padding-left: 1.2rem;
    }

    .rankitem { margin: 6px 0; }

    .mono {
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
    }

    .sep {
      margin: 10px 0;
      height: 1px;
      background: rgba(0,0,0,0.08);
    }
  </style>
</head>
<body>

<div class="container">
  <h1>10ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>

  <div id="time" class="time">ã€€</div>

  <button id="mainBtn" type="button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

  <div id="result" class="result"></div>

  <div id="hiscore" class="hiscore"></div>
  <button id="resetBtn" type="button" style="background:#8892a6;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
  let startTime = null;
  let isRunning = false;

  const timeDisplay = document.getElementById('time');
  const resultDisplay = document.getElementById('result');
  const mainBtn = document.getElementById('mainBtn');
  const hiscoreDisplay = document.getElementById('hiscore');
  const resetBtn = document.getElementById('resetBtn');

  // ---- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ã‚­ãƒ¼ï¼ˆä¸Šä½10ä»¶ï¼‰----
  const RANK_KEY = "tenSecChallenge_rankings_v2";
  const MAX_RANK = 10;

  // ---- äºŒé‡ç™ºç«é˜²æ­¢ï¼ˆpointerdownâ†’click ãªã©ï¼‰----
  let lastActionAt = 0;
  const ACTION_GUARD_MS = 350;

  function nowMs() {
    return performance.now();
  }

  function formatDate(ts) {
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}/${m}/${day} ${hh}:${mm}`;
  }

  function safeNumber(n) {
    return (typeof n === "number" && Number.isFinite(n)) ? n : null;
  }

  function loadRankings() {
    try {
      const raw = localStorage.getItem(RANK_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];

      const cleaned = arr.map(x => ({
        elapsed: safeNumber(x?.elapsed),
        diff: safeNumber(x?.diff),
        ts: safeNumber(x?.ts)
      })).filter(r => r.elapsed !== null && r.diff !== null && r.ts !== null);

      return cleaned.slice(0, 200); // å¿µã®ãŸã‚
    } catch {
      return [];
    }
  }

  function saveRankings(ranks) {
    localStorage.setItem(RANK_KEY, JSON.stringify(ranks));
  }

  // diff å°ã•ã„ã»ã©ä¸Šä½ã€‚å®Œå…¨åŒç‚¹ãªã‚‰ elapsed å°ã•ã„æ–¹ã‚’ä¸Šä½ï¼ˆå¥½ã¿ã§å¤‰æ›´OKï¼‰ã€‚
  function compareRecord(a, b) {
    if (a.diff !== b.diff) return a.diff - b.diff;
    if (a.elapsed !== b.elapsed) return a.elapsed - b.elapsed;
    return a.ts - b.ts;
  }

  // â˜…ä¿®æ­£: ãƒã‚¤ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’å»ƒæ­¢ã—ã¦ã€Œä¸Šä½10ä½ã®ãƒªã‚¹ãƒˆã€ã ã‘è¡¨ç¤º
  function renderRankings(ranks) {
    const sorted = [...ranks].sort(compareRecord).slice(0, MAX_RANK);

    let html = "";
    html += `<div class="rankhead">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¸Šä½${MAX_RANK}ä»¶ï¼‰</div>`;

    if (!sorted.length) {
      html += `ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`;
      hiscoreDisplay.innerHTML = html;
      return;
    }

    html += `<ol class="ranklist">`;
    for (let i = 0; i < sorted.length; i++) {
      const r = sorted[i];
      html += `<li class="rankitem">èª¤å·® <b class="mono">${r.diff.toFixed(3)} ç§’</b> / `;
      html += `è¨˜éŒ² <span class="mono">${r.elapsed.toFixed(3)} ç§’</span><br>`;
      html += `<span style="color:#666;">${formatDate(r.ts)}</span></li>`;
    }
    html += `</ol>`;

    hiscoreDisplay.innerHTML = html;
  }

  // åˆæœŸè¡¨ç¤º
  let rankings = loadRankings();
  renderRankings(rankings);

  function setRunningUI(running) {
    isRunning = running;

    if (running) {
      mainBtn.textContent = "ã‚¹ãƒˆãƒƒãƒ—";
      mainBtn.style.background = "#ff6b6b";
      resetBtn.disabled = true; // è¨ˆæ¸¬ä¸­ã¯ãƒªã‚»ãƒƒãƒˆç¦æ­¢
    } else {
      mainBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆ";
      mainBtn.style.background = "#4b6fff";
      resetBtn.disabled = false;
    }
  }

  function shouldGuardAction() {
    const t = nowMs();
    if (t - lastActionAt < ACTION_GUARD_MS) return true;
    lastActionAt = t;
    return false;
  }

  function handleStart() {
    startTime = nowMs();
    resultDisplay.textContent = "";
    timeDisplay.textContent = "è¨ˆæ¸¬ä¸­â€¦";
    setRunningUI(true);
  }

  function handleStop() {
    const end = nowMs();
    setRunningUI(false);

    const elapsed = (end - startTime) / 1000;
    const diff = Math.abs(elapsed - 10);

    timeDisplay.textContent = elapsed.toFixed(3) + " ç§’";
    resultDisplay.textContent = `èª¤å·®ï¼š${diff.toFixed(3)} ç§’`;

    const beforeTop10 = [...rankings].sort(compareRecord).slice(0, MAX_RANK);

    const newRec = { elapsed, diff, ts: Date.now() };
    const merged = [...rankings, newRec].sort(compareRecord).slice(0, MAX_RANK);

    const entered = JSON.stringify(beforeTop10) !== JSON.stringify(merged);

    if (entered) {
      rankings = merged;
      saveRankings(rankings);
      renderRankings(rankings);
      resultDisplay.textContent += "ï¼ˆğŸ‰ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥ã‚Šï¼‰";
    } else {
      resultDisplay.textContent += "ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°å¤–ï¼‰";
    }
  }

  function triggerAction(srcEvent) {
    if (srcEvent) {
      // preventDefault ã¯ touch/pen ã®ã¿ã«é™å®šï¼ˆmouse ã¯åŸºæœ¬è§¦ã‚‰ãªã„ï¼‰
      if (srcEvent.type === "pointerdown") {
        if (srcEvent.pointerType === "touch" || srcEvent.pointerType === "pen") {
          srcEvent.preventDefault();
        }
      } else if (srcEvent.type === "keydown") {
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç­‰ã‚’æ­¢ã‚ãŸã„ã®ã§ preventDefault
        srcEvent.preventDefault();
      }
    }

    if (shouldGuardAction()) return;

    if (!isRunning) handleStart();
    else handleStop();
  }

  // pointerdownï¼ˆä½“æ„Ÿãƒ©ã‚°ä½æ¸›ï¼‰
  mainBtn.addEventListener('pointerdown', (e) => triggerAction(e));

  // clickï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰Enter/Spaceæ•‘æ¸ˆ + ç’°å¢ƒå·®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  mainBtn.addEventListener('click', (e) => triggerAction(e));

  // â˜…ä¿®æ­£: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®ç«¶åˆã‚’å›é¿ï¼ˆæ“ä½œå¯èƒ½è¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹æ™‚ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã—ãªã„ï¼‰
  document.addEventListener('keydown', (e) => {
    const k = e.key;
    if (!(k === "Enter" || k === " " || k === "Spacebar")) return;

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã€Œãƒœã‚¿ãƒ³/ãƒªãƒ³ã‚¯/å…¥åŠ›ã€ç­‰ã®æ“ä½œè¦ç´ ã«ã‚ã‚‹å ´åˆã¯ã€ãã®è¦ç´ æœ¬æ¥ã®æŒ™å‹•ã«ä»»ã›ã‚‹
    const t = e.target;
    if (t && typeof t.closest === "function") {
      const interactive = t.closest('button, a, input, textarea, select, summary, [role="button"], [contenteditable="true"]');
      if (interactive) return;
    }

    // ãã‚Œä»¥å¤–ï¼ˆèƒŒæ™¯ç­‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼‰ãªã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹/åœæ­¢ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¨ã—ã¦ä½¿ã†
    triggerAction(e);
  }, { passive: false });

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚»ãƒƒãƒˆï¼ˆpointerdown + clickï¼‰
  function resetRanking(e) {
    if (e && e.type === "pointerdown") {
      if (e.pointerType === "touch" || e.pointerType === "pen") e.preventDefault();
    }
    if (isRunning) return;

    localStorage.removeItem(RANK_KEY);
    rankings = [];
    renderRankings(rankings);
    resultDisplay.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ";
  }

  resetBtn.addEventListener('pointerdown', resetRanking);
  resetBtn.addEventListener('click', resetRanking);
</script>

</body>
</html>
