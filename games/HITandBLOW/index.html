<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>HITandBLOW</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:16px 10px;
      background: radial-gradient(circle at top, #eef3ff, #cfd8e3);
    }

    .game-container{
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
      padding: 16px 14px 14px;
      width: min(520px, 96vw);
      overflow: hidden; /* はみ出し対策 */
    }

    h1{
      font-size: 1.35rem;
      margin: 2px 0 12px;
      text-align:center;
      letter-spacing: 0.02em;
    }

    /* 入力周り */
    form#guessForm{
      display:flex;
      gap: 8px;
      align-items: stretch;
      margin-bottom: 8px;
      width: 100%;
    }

    .attempt-badge{
      flex: 0 0 auto;
      min-width: 64px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #f0f3ff;
      border: 1px solid #d7defa;
      color: #1d2a57;
      text-align:center;
      font-weight: 700;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space: nowrap;
    }

    #guessInput{
      flex: 1 1 auto;
      min-width: 0; /* 重要：flex内で縮める */
      padding: 10px 10px;
      font-size: 1.15rem;
      text-align:center;
      border-radius: 12px;
      border: 1px solid #c4c9d6;
      outline: none;
      transition: box-shadow .15s, border-color .15s;
      background: #fff;
    }
    #guessInput:focus{
      border-color: #4b6fff;
      box-shadow: 0 0 0 2px rgba(75,111,255,0.2);
    }

    button{
      border:none;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.95rem;
      cursor:pointer;
      white-space: nowrap;
      transition: transform .05s ease, box-shadow .05s ease, opacity .15s;
      user-select:none;
    }
    button:active:not(:disabled){
      transform: translateY(1px);
      box-shadow:none;
    }
    button:disabled{
      opacity: 0.5;
      cursor: default;
      box-shadow:none;
    }

    #guessButton{
      flex: 0 0 auto;
      min-width: 72px; /* 小さめ */
      background:#4b6fff;
      color:#fff;
      box-shadow: 0 4px 10px rgba(75,111,255,0.45);
    }

    /* メッセージ（ヒントは出さない：エラー or 正解のみ） */
    #message{
      font-size: 0.92rem;
      margin: 4px 0 8px;
      min-height: 1.2em;
    }
    #message.ok{ color:#0c8a3e; }
    #message.error{ color:#c0392b; }

    /* 予想履歴：スクロールしないで全表示（小さめ・詰める） */
    .log{
      border-top: 1px solid #dde1ee;
      padding-top: 8px;
      margin-top: 6px;
    }
    .log-header, .log-row{
      display:grid;
      grid-template-columns: 44px 1fr 56px 56px;
      gap: 6px;
      align-items:center;
    }
    .log-header{
      font-weight:700;
      padding: 6px 6px;
      background:#f6f7fb;
      border:1px solid #e2e6f4;
      border-radius: 12px;
      margin-bottom: 6px;
      font-size: 0.86rem;
    }
    #logBody{ display:flex; flex-direction:column; gap:2px; }
    .log-row{
      padding: 4px 6px;
      border-radius: 10px;
      font-size: 0.86rem;         /* 文字を少し小さく */
      line-height: 1.25;          /* 行間を狭く */
    }
    .log-row:nth-child(even){
      background:#f7f8fc;
    }
    .muted{
      color:#777;
      font-size: 0.86rem;
      padding: 4px 6px;
    }

    /* リセット：履歴の下 */
    .controls{
      display:flex;
      justify-content:flex-end;
      margin-top: 10px;
    }
    #resetButton{
      background:#e4e7f2;
      color:#333;
      padding: 10px 12px;
      border-radius: 12px;
    }

    /* 記録（統計） */
    .stats{
      margin-top: 14px;
      border-top: 1px solid #dde1ee;
      padding-top: 12px;
    }
    .stats-title{
      font-weight: 800;
      margin: 0 0 8px;
      font-size: 1.0rem;
    }
    .stats-summary{
      font-size: 0.88rem;
      color:#444;
      background:#f5f7fb;
      border-radius: 12px;
      padding: 8px 10px;
      line-height: 1.55;
      margin-bottom: 10px;
    }
    .stats-table{
      border: 1px solid #e2e6f4;
      border-radius: 12px;
      overflow:hidden;
    }
    .stats-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      padding: 8px 10px;
      font-size: 0.9rem;
      background:#fff;
    }
    .stats-row:nth-child(even){
      background:#f7f8fc;
    }
    .stats-head{
      font-weight:700;
      background:#f6f7fb;
    }

    /* 記録消去：押し間違い防止で“遠い位置”（下の方） */
    .danger-zone{
      margin-top: 14px;
      display:flex;
      justify-content:flex-end;
    }
    #clearStatsButton{
      background:#fde7ea;
      color:#8c2b35;
      border: 1px solid #f6c9d0;
      padding: 10px 12px;
      border-radius: 12px;
    }

    /* ルール：折りたたみで場所を取らない＋重なり回避 */
    details.rules{
      margin-top: 14px;
      border-top: 1px solid #dde1ee;
      padding-top: 10px;
    }
    details.rules summary{
      cursor:pointer;
      font-weight: 800;
      user-select:none;
      padding: 8px 2px;
    }
    .rules-box{
      font-size: 0.88rem;
      color:#444;
      background:#f5f7fb;
      border-radius: 12px;
      padding: 10px 12px;
      line-height: 1.6;
    }
    .rules-box ul{
      padding-left: 1.2em;
      margin: 6px 0 0;
    }

    .answer-hint{
      margin-top: 10px;
      font-size: 0.82rem;
      color:#666;
      text-align:right;
      cursor:pointer;
      user-select:none;
    }
    .answer-hint span{
      text-decoration: underline;
    }

    @media (max-width: 420px){
      body{ padding: 10px 8px; }
      .game-container{ padding: 14px 12px 12px; }
      .attempt-badge{ min-width: 58px; padding: 8px 8px; }
      #guessButton{ min-width: 66px; padding: 10px 10px; }
      .log-header, .log-row{
        grid-template-columns: 40px 1fr 52px 52px;
        gap: 6px;
      }
      .log-row, .log-header{
        font-size: 0.84rem;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>HITandBLOW</h1>

    <form id="guessForm" autocomplete="off">
      <div class="attempt-badge"><span id="attemptBadge">1回目</span></div>
      <input
        id="guessInput"
        type="text"
        maxlength="4"
        inputmode="numeric"
        aria-label="4桁の数字を入力"
        placeholder="例）1234"
      />
      <button id="guessButton" class="primary-btn" type="submit">判定</button>
    </form>

    <div id="message"></div>

    <div class="log" aria-label="予想結果履歴">
      <div class="log-header">
        <div>#</div>
        <div>予想</div>
        <div>ヒット</div>
        <div>ブロー</div>
      </div>
      <div id="logBody"></div>
      <div id="logEmpty" class="muted">まだ履歴がありません</div>
    </div>

    <div class="controls">
      <button id="resetButton" type="button">リセット</button>
    </div>

    <div class="stats" aria-label="クリア回数の分布">
      <p class="stats-title">記録（クリア回数の分布）</p>
      <div class="stats-summary" id="statsSummary">総クリア回数：0回 / ベスト：- / 平均：-</div>

      <div class="stats-table" id="statsTable">
        <div class="stats-row stats-head">
          <div>クリア回数</div>
          <div>回数</div>
        </div>
        <div class="stats-row">
          <div>-</div>
          <div>まだ記録がありません</div>
        </div>
      </div>

      <div class="danger-zone">
        <button id="clearStatsButton" type="button">記録を消去</button>
      </div>
    </div>

    <details class="rules">
      <summary>ルール</summary>
      <div class="rules-box">
        <ul>
          <li>相手の「4桁の数字」を当てるゲームです。</li>
          <li>同じ数字は1回だけ使われます（重複なし）。</li>
          <li>先頭は0ではありません（1000〜9999）。</li>
          <li>位置も数字も一致：<strong>ヒット</strong></li>
          <li>数字は合っているが位置が違う：<strong>ブロー</strong></li>
        </ul>
      </div>
    </details>

    <div class="answer-hint" id="showAnswerHint">
      （どうしても分からないときは <span>答えを見る</span>）
    </div>
  </div>

  <script>
    // ====== 状態 ======
    let secretNumber = "";
    let attempts = 0;
    let gameOver = false;
    let busy = false; // Enter連打・二重発火対策

    // LocalStorage（バージョン付き）
    const STATS_KEY = "hitandblow_stats_v1";

    function generateSecret() {
      const digits = ["0","1","2","3","4","5","6","7","8","9"];
      let secret = "";

      // 1桁目：1〜9
      const firstIndex = Math.floor(Math.random() * 9) + 1; // 1〜9
      secret += digits[firstIndex];
      digits.splice(firstIndex, 1);

      // 残り3桁：重複なし
      for (let i = 0; i < 3; i++) {
        const idx = Math.floor(Math.random() * digits.length);
        secret += digits[idx];
        digits.splice(idx, 1);
      }
      return secret;
    }

    // ====== UIヘルパ ======
    function setMessage(text, type = "") {
      const el = document.getElementById("message");
      el.textContent = text || "";
      el.className = type ? type : "";
    }

    function setAttemptBadge() {
      // 「次に入力する回数」を表示（ただし、正解時は attempts 回目で固定）
      const badge = document.getElementById("attemptBadge");
      badge.textContent = `${Math.max(1, attempts + 1)}回目`;
    }

    function setAttemptBadgeFixedToSolved() {
      const badge = document.getElementById("attemptBadge");
      badge.textContent = `${attempts}回目`;
    }

    function updateLogEmptyState() {
      const body = document.getElementById("logBody");
      const empty = document.getElementById("logEmpty");
      empty.style.display = body.children.length ? "none" : "block";
    }

    // ====== 入力検証 ======
    function validateGuess(guess) {
      if (guess.length !== 4) return "4桁の数字を入力してください。";
      if (!/^\d{4}$/.test(guess)) return "数字のみを入力してください。";
      if (guess[0] === "0") return "先頭は0以外にしてください。";
      const set = new Set(guess.split(""));
      if (set.size !== 4) return "同じ数字を重複させずに入力してください。";
      return "";
    }

    // ====== 判定 ======
    function judge(guess, secret) {
      let hits = 0;
      let blows = 0;

      for (let i = 0; i < 4; i++) {
        if (guess[i] === secret[i]) hits++;
        else if (secret.includes(guess[i])) blows++;
      }
      return { hits, blows };
    }

    function addLogRow(guess, hits, blows) {
      const logBody = document.getElementById("logBody");
      const row = document.createElement("div");
      row.className = "log-row";

      const idxCell = document.createElement("div");
      idxCell.textContent = attempts;

      const guessCell = document.createElement("div");
      guessCell.textContent = guess;

      const hitCell = document.createElement("div");
      hitCell.textContent = hits;

      const blowCell = document.createElement("div");
      blowCell.textContent = blows;

      row.appendChild(idxCell);
      row.appendChild(guessCell);
      row.appendChild(hitCell);
      row.appendChild(blowCell);

      // ★新しい履歴を上に表示
      logBody.prepend(row);

      updateLogEmptyState();
    }

    // ====== 記録（統計） ======
    function loadStats() {
      try {
        const raw = localStorage.getItem(STATS_KEY);
        if (!raw) {
          return { counts: {}, totalClears: 0, totalAttempts: 0 };
        }
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object") throw new Error("bad");
        if (!obj.counts) obj.counts = {};
        if (typeof obj.totalClears !== "number") obj.totalClears = 0;
        if (typeof obj.totalAttempts !== "number") obj.totalAttempts = 0;
        return obj;
      } catch {
        // 壊れてたら初期化
        return { counts: {}, totalClears: 0, totalAttempts: 0 };
      }
    }

    function saveStats(stats) {
      localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    }

    function addClearRecord(clearAttempts) {
      const stats = loadStats();
      const key = String(clearAttempts);
      stats.counts[key] = (stats.counts[key] || 0) + 1;
      stats.totalClears += 1;
      stats.totalAttempts += clearAttempts;
      saveStats(stats);
      renderStats();
    }

    function clearStats() {
      localStorage.removeItem(STATS_KEY);
      renderStats();
    }

    function renderStats() {
      const stats = loadStats();
      const summaryEl = document.getElementById("statsSummary");
      const tableEl = document.getElementById("statsTable");

      const total = stats.totalClears || 0;
      const avg = total > 0 ? (stats.totalAttempts / total) : null;

      // best = 最小回数
      let best = null;
      const keys = Object.keys(stats.counts).map(n => Number(n)).filter(n => Number.isFinite(n));
      if (keys.length) best = Math.min(...keys);

      summaryEl.textContent =
        `総クリア回数：${total}回 / ベスト：${best ?? "-"} / 平均：${avg === null ? "-" : avg.toFixed(2)}`;

      // テーブル再構築
      tableEl.innerHTML = "";
      const head = document.createElement("div");
      head.className = "stats-row stats-head";
      head.innerHTML = "<div>クリア回数</div><div>回数</div>";
      tableEl.appendChild(head);

      if (!keys.length) {
        const row = document.createElement("div");
        row.className = "stats-row";
        row.innerHTML = "<div>-</div><div>まだ記録がありません</div>";
        tableEl.appendChild(row);
        return;
      }

      keys.sort((a,b)=>a-b);
      for (const k of keys) {
        const row = document.createElement("div");
        row.className = "stats-row";
        row.innerHTML = `<div>${k}回</div><div>${stats.counts[String(k)]}回</div>`;
        tableEl.appendChild(row);
      }
    }

    // ====== ゲーム制御 ======
    function setGameEnabled(enabled) {
      const input = document.getElementById("guessInput");
      const btn = document.getElementById("guessButton");
      input.disabled = !enabled;
      btn.disabled = !enabled;
    }

    function resetGame() {
      secretNumber = generateSecret();
      attempts = 0;
      gameOver = false;
      busy = false;

      document.getElementById("guessInput").value = "";
      setGameEnabled(true);
      setMessage("", "");
      document.getElementById("logBody").innerHTML = "";
      updateLogEmptyState();
      setAttemptBadge();

      // console.log("Secret:", secretNumber); // デバッグ用
      document.getElementById("guessInput").focus();
    }

    function handleGuess() {
      if (gameOver || busy) return;

      const input = document.getElementById("guessInput");
      const rawGuess = input.value.trim();

      const error = validateGuess(rawGuess);
      if (error) {
        setMessage(error, "error");
        return;
      }

      busy = true; // 連打防止
      const btn = document.getElementById("guessButton");
      btn.disabled = true;

      attempts++;

      const result = judge(rawGuess, secretNumber);
      addLogRow(rawGuess, result.hits, result.blows);

      if (result.hits === 4) {
        // 正解
        setMessage(`正解！ ${attempts}回目で当てました。`, "ok");
        gameOver = true;
        setAttemptBadgeFixedToSolved();
        setGameEnabled(false);
        addClearRecord(attempts);

        // ★正解時：リセットボタンへフォーカス
        document.getElementById("resetButton").focus();
      } else {
        // ヒントは不要（表示しない）
        setMessage("", "");
        setAttemptBadge();
        input.value = "";
        input.focus();
        btn.disabled = false;
      }

      // 次フレームでbusy解除（Enter二重発火対策を強める）
      requestAnimationFrame(() => { busy = false; });
    }

    // ====== イベント ======
    window.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("guessForm");
      const resetBtn = document.getElementById("resetButton");
      const showAnswerHint = document.getElementById("showAnswerHint");
      const clearStatsBtn = document.getElementById("clearStatsButton");

      // submit一本化（Enter / ボタン どちらもここに集約）→二重発火しにくい
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        handleGuess();
      });

      resetBtn.addEventListener("click", resetGame);

      showAnswerHint.addEventListener("click", () => {
        if (!secretNumber || gameOver) return;
        // 降参：記録には入れない（※入れたいなら addClearRecord(...) してください）
        setMessage(`答えは「${secretNumber}」です。新しく遊ぶ場合はリセットしてください。`, "ok");
        gameOver = true;
        setGameEnabled(false);

        // 次の操作へ誘導
        document.getElementById("resetButton").focus();
      });

      clearStatsBtn.addEventListener("click", () => {
        // 押し間違い防止：確認
        const ok = confirm("記録をすべて消去します。よろしいですか？");
        if (!ok) return;
        clearStats();
      });

      renderStats();
      resetGame();
    });
  </script>
</body>
      </html>
